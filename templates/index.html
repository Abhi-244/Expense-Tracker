<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üí∏ Expense Splitter</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

{% if not logged_in %}
<div class="login-container">
    <div class="login-card">
        <h1>üí∏ Expense Splitter</h1>
        <form method="POST" action="/login">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button class="btn-login">Login</button>
        </form>
        <p class="text-center">Don't have an account? 
            <a href="#" onclick="document.getElementById('register-form').style.display='block'; this.style.display='none';">Register</a>
        </p>
        <div id="register-form" style="display:none; margin-top:10px;">
            <form method="POST" action="/register">
                <input type="text" name="username" placeholder="New Username" required>
                <input type="password" name="password" placeholder="New Password" required>
                <button class="btn-register">Register</button>
            </form>
        </div>
    </div>
</div>
{% else %}

<div style="margin:auto; max-width:1200px;">
    <div class="top-bar">
        <h2>Welcome, {{ username }} üéâ</h2>
    </div>

    <div class="content-row">
        <!-- Left Column -->
        <div class="col-left">
            <!-- Add Expense -->
            <div class="card card-small">
                <h2>‚ûï Add Expense</h2>
                <form method="POST" action="/add" onsubmit="return validateMembers(this)" class="form-inline">
                    <input type="text" name="paid_by" placeholder="Who Paid?" required>
                    <input type="number" step="0.01" name="amount" placeholder="Amount" required>
                    <input type="text" name="members" placeholder="Members" required>
                    <button class="btn-add">Add</button>
                </form>
            </div>

            <!-- Expenses Table -->
            <div class="card card-small">
                <h2>üìã Your Expenses</h2>
                {% if expenses %}
                <table>
                    <tr><th>ID</th><th>Paid By</th><th>Amount</th><th>Members</th><th>Action</th></tr>
                    {% for e in expenses %}
                    <tr>
                        <td>{{ e.id }}</td>
                        <td>{{ e.paid_by }}</td>
                        <td>{{ "%.2f"|format(e.amount) }}</td>
                        <td>{{ e.members|join(', ') }}</td>
                        <td>
                            <div class="btn-group">
                                <a href="/edit/{{ e.id }}"><button class="btn-edit">Edit</button></a>
                                <a href="/delete/{{ e.id }}"><button class="btn-delete">Delete</button></a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
                {% else %}
                <p>No expenses yet.</p>
                {% endif %}
            </div>

            <!-- Settlements -->
            <div class="card card-small">
                <h2>‚öñÔ∏è Settlements</h2>
                {% if settlements %}
                <table class="settlement-table">
                    <tr><th>Settlement</th></tr>
                    {% for s in settlements %}
                    <tr><td>{{ s }}</td></tr>
                    {% endfor %}
                </table>
                {% else %}
                <p>No settlements yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-right">
            <div class="card card-large">
                <h2>üìä Balances Overview</h2>
                <canvas id="balancesChart"></canvas>
            </div>
        </div>
    </div>

    <div style="text-align:center;">
        <a href="/logout"><button class="btn-logout">Logout</button></a>
    </div>
</div>

<script>
function validateMembers(form){
    const members = form.members.value.split(",").map(m=>m.trim()).filter(Boolean);
    if(members.length===0){ alert("Please enter valid member names!"); return false; }
    form.members.value = members.join(", ");
    return true;
}

{% if logged_in %}
const ctx = document.getElementById('balancesChart').getContext('2d');
const labels = [{% for name in balances.keys() %}'{{ name }}',{% endfor %}];
const dataValues = [{% for val in balances.values() %}{{ val }},{% endfor %}];
const colors = [{% for val in balances.values() %}'rgba({{ (loop.index0*50)%255 }}, {{ (255-(loop.index0*50))%255 }}, {{ (loop.index0*80)%255 }},0.7)',{% endfor %}];

new Chart(ctx,{
    type:'bar',
    data:{ labels: labels, datasets:[{label:'Balance', data: dataValues, backgroundColor: colors }] },
    options:{
        responsive:true,
        maintainAspectRatio:false,
        layout: { padding: 10 },
        scales:{ y:{ beginAtZero:true } },
        plugins:{ legend:{ display:false } }
    }
});
{% endif %}
</script>

{% endif %}
</body>
</html>
